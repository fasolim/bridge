require('dotenv').config();
const mongoose = require('mongoose');
const BugMetrics = require('../app/models/BugMetrics');

// Dados extra√≠dos via MCP do Notion com todos os detalhes
const enhancedBugs = [
  {
    id: "28ecd984-590f-8016-a140-e38cca5476a5",
    title: "Campos de IP indevidos no modal \"Confirmar Pagamento\"",
    url: "https://www.notion.so/28ecd984590f8016a140e38cca5476a5",
    properties: {
      categoria: ["Bug"],
      status: "Conclu√≠do",
      modulo: ["Despesas"],
      prioridade: 0,
      dataPrevista: false,
      criadoPor: "Maria Vit√≥ria Machado",
      editadoEm: "2025-10-16T17:04:14.636Z"
    },
    content: {
      resumo: "Os campos IP Principal e IP Adicional est√£o sendo exibidos indevidamente no modal de Confirmar Pagamento de despesa. Esses campos pertencem apenas √† se√ß√£o de cadastro de m√°quinas ou infraestrutura e n√£o deveriam aparecer neste fluxo.",
      passosReproduzir: [
        "Acessar o m√≥dulo Gerenciamento de Despesas",
        "Clicar em Confirmar Pagamento de qualquer despesa",
        "Rolar o modal at√© a se√ß√£o Dados da M√°quina",
        "Observar os campos IP Principal e IP Adicional vis√≠veis no modal"
      ],
      resultadoAtual: "Os campos IP Principal e IP Adicional aparecem no modal, permitindo entrada manual de endere√ßos IP, mesmo quando a despesa n√£o est√° vinculada a um registro de m√°quina.",
      resultadoEsperado: "Os campos IP Principal e IP Adicional n√£o devem aparecer no modal de confirma√ß√£o de pagamento, pois n√£o s√£o relevantes para o contexto financeiro. Esses campos devem: Ser removidos completamente da tela de confirma√ß√£o de pagamento. Permanecer apenas nas telas de cadastro de m√°quinas (infraestrutura/invent√°rio).",
      impactoNegocio: "Esses campos confundem os usu√°rios do financeiro, gerando d√∫vidas sobre a necessidade de preenchimento e poss√≠veis erros de dados. Al√©m disso, adicionam ru√≠do visual desnecess√°rio no fluxo de confirma√ß√£o de pagamento.",
      sugestaoCorrecao: [
        "Remover os campos de IP da renderiza√ß√£o condicional do modal Confirmar Pagamento",
        "Garantir que o componente de IP permane√ßa dispon√≠vel apenas na tela de Infraestrutura / Cadastro de M√°quina",
        "Verificar se h√° depend√™ncia compartilhada entre modais e modularizar o formul√°rio"
      ],
      anexos: ["Screenshot do modal com campos IP vis√≠veis"]
    }
  },
  {
    id: "28ecd984-590f-806e-ad4c-e7cb191c4fe7",
    title: "M√°scara de Moeda n√£o aplicada no campo \"Valor\" do modal Confirmar Pagamento",
    url: "https://www.notion.so/28ecd984590f806ead4ce7cb191c4fe7",
    properties: {
      categoria: ["Bug"],
      status: "Pronto pra teste",
      modulo: ["Despesas"],
      prioridade: 0,
      dataPrevista: false,
      criadoPor: "Maria Vit√≥ria Machado",
      editadoEm: "2025-10-16T18:09:18.996Z"
    },
    content: {
      resumo: "Campo Valor no modal de confirma√ß√£o de pagamento est√° sem m√°scara de moeda BRL, permitindo entrada livre (ex: n√∫mero inteiro 0) sem formata√ß√£o monet√°ria.",
      passosReproduzir: [
        "Ir para Gerenciamento de Despesas",
        "Selecionar uma despesa qualquer e clicar em Confirmar Pagamento (abrir modal)",
        "Observar o campo Valor (lado direito, pr√≥ximo √† moeda selecionada)",
        "Inserir qualquer n√∫mero (ex: 1000)"
      ],
      resultadoAtual: "O campo Valor aceita entrada num√©rica pura (ex: 0, 1000) sem m√°scara de moeda BRL. N√£o h√° separador de milhar, v√≠rgula decimal ou prefixo de moeda.",
      resultadoEsperado: "O campo Valor deve aplicar m√°scara de moeda automaticamente ao digitar, conforme padr√£o BRL. Exemplo: digitar 1000 ‚Üí exibir R$ 1.000,00. Prefixo BRL fixo conforme sele√ß√£o do campo \"Moeda\". Formata√ß√£o consistente com o restante do sistema financeiro.",
      criteriosAceitacao: [
        "Campo Valor exibe e aplica m√°scara de moeda BRL dinamicamente",
        "Mant√©m compatibilidade com as moedas dispon√≠veis (caso o sistema suporte m√∫ltiplas moedas)",
        "Valida√ß√£o impede entrada de valores inv√°lidos (ex: letras, m√∫ltiplos pontos decimais, negativos ‚Äî a depender da regra de neg√≥cio)",
        "M√°scara n√£o interfere no envio correto do valor (payload num√©rico convertido corretamente para centavos ou float, conforme backend)",
        "Pegue o mesmo componente da mascara de valor de nova transfer√™ncia interna"
      ],
      dadosUteis: {
        console: "verificar se h√° warnings de formata√ß√£o",
        requestResponse: "confirmar se o valor enviado no payload est√° correto"
      },
      impactoNegocio: "A aus√™ncia de m√°scara pode gerar confus√£o no preenchimento e erros de valor, especialmente em lan√ßamentos de grandes valores. Impacta confiabilidade e consist√™ncia dos dados financeiros.",
      sugestaoCorrecao: [
        "Aplicar componente de input monet√°rio com m√°scara BRL (reutilizar padr√£o existente no sistema se houver)",
        "Garantir compatibilidade com diferentes moedas (usando campo \"Moeda\" como refer√™ncia)",
        "Testar em diferentes navegadores e tamanhos de tela (mobile/responsivo)",
        "Adicionar testes unit√°rios e e2e de m√°scara monet√°ria"
      ],
      observacoesAdicionais: "Confirmar se o formato deve seguir padr√£o brasileiro (R$ 1.000,00) ou internacional (BRL 1,000.00) conforme configura√ß√£o global do sistema.",
      anexos: ["Screenshot do campo sem m√°scara"]
    }
  },
  {
    id: "28ecd984-590f-80a5-8d9f-fde2cc67a92e",
    title: "Novo(a) ideia",
    url: "https://www.notion.so/28ecd984590f80a58d9ffde2cc67a92e",
    properties: {
      categoria: [],
      status: "N√£o iniciada",
      modulo: ["Despesas"],
      prioridade: 0,
      dataPrevista: false,
      criadoPor: "Maria Vit√≥ria Machado",
      editadoEm: "2025-10-17T13:37:10.856Z"
    },
    content: {
      resumo: "P√°gina de template para novas ideias - ainda n√£o preenchida",
      descricao: "Insira uma descri√ß√£o em duas ou tr√™s frases.",
      importancia: [
        "Campo vazio",
        "Campo vazio", 
        "Campo vazio"
      ],
      dadosApoio: "Vincule conversas do slack, relat√≥rios anal√≠ticos etc."
    }
  },
  {
    id: "28ecd984-590f-80bd-a0e4-d86f4fb5debf",
    title: "Valor deve ser edit√°vel no modal \"Confirmar Pagamento\"",
    url: "https://www.notion.so/28ecd984590f80bda0e4d86f4fb5debf",
    properties: {
      categoria: ["Bug"],
      status: "Conclu√≠do",
      modulo: ["Despesas"],
      prioridade: 0,
      dataPrevista: false,
      criadoPor: "Maria Vit√≥ria Machado",
      editadoEm: "2025-10-16T16:42:22.011Z"
    },
    content: {
      resumo: "Campo Valor exibido no modal de confirma√ß√£o de pagamento est√° como somente leitura; deve ser poss√≠vel editar o valor antes de confirmar o pagamento.",
      passosReproduzir: [
        "Ir para Gerenciamento de Despesas",
        "Selecionar uma despesa qualquer e clicar em Confirmar Pagamento (abrir modal)",
        "Observar o campo Valor destacado (lado superior direito do modal)",
        "Tentar editar o valor (clicar dentro do campo e digitar um novo valor)"
      ],
      resultadoAtual: "O campo Valor √© exibido como texto formatado (BRL 50,00) e n√£o permite edi√ß√£o ‚Äî campo est√° como somente leitura.",
      resultadoEsperado: "O campo Valor deve ser um input edit√°vel (ou ter um bot√£o/√≠cone para editar) permitindo que o usu√°rio ajuste o valor manualmente antes de confirmar o pagamento. Deve manter valida√ß√£o de formato (decimal, separador de milhar/opcional) e m√°scaras de moeda.",
      criteriosAceitacao: [
        "O campo Valor aparece como input edit√°vel ao abrir o modal",
        "Permite entrada num√©rica com m√°scara BRL (ex: R$ 1.234,56 ou BRL 1234.56 conforme padr√£o do produto)",
        "Valida√ß√£o de valor: n√£o aceitar valores negativos; m√≠nimo = 0,00; m√°ximo conforme regra de neg√≥cio",
        "Ao confirmar, o valor editado √© enviado corretamente para a API e refletido na despesa (status/valor atualizado)",
        "Testes unit√°rios e e2e cobrindo edi√ß√£o e envio do valor"
      ],
      dadosUteis: {
        console: "colar erros se houver",
        requestResponse: "capturar requisi√ß√£o que salva confirma√ß√£o de pagamento",
        payloadEsperado: "{ \"amount\": 50.00, ... }"
      },
      impactoNegocio: "Usu√°rios n√£o conseguem corrigir/ajustar o valor ao confirmar pagamento, o que pode gerar lan√ßamentos incorretos no financeiro e retrabalho manual ‚Äî impacto direto na confiabilidade dos registros e fluxo de concilia√ß√£o.",
      sugestaoCorrecao: [
        "Substituir o elemento atual por um input controlado (type=\"text\"/\"number\") com m√°scara de moeda",
        "Garantir que a m√°scara/formata√ß√£o n√£o atrapalhe a convers√£o para n√∫mero no payload",
        "Reutilizar componente de input monet√°rio j√° existente (se houver) para manter consist√™ncia",
        "Atualizar testes (unit√°rios e e2e) e criar caso de QA para validar comportamento em mobile/responsivo"
      ],
      anexos: ["Screenshot do campo destacado"]
    }
  }
];

async function syncEnhancedBugs() {
  try {
    // Conectar ao MongoDB
    await mongoose.connect(process.env.MONGODB_URI);
    console.log('‚úÖ Conectado ao MongoDB');
    
    let syncedCount = 0;
    let updatedCount = 0;
    const errors = [];
    
    // Processar cada bug com dados detalhados
    for (const bug of enhancedBugs) {
      try {
        console.log(`üîç Processando: ${bug.title}`);
        
        // Mapear status do Notion para interno
        const statusMap = {
          'conclu√≠do': 'resolved',
          'pronto pra teste': 'pending',
          'n√£o iniciada': 'pending',
          'em progresso': 'in_progress',
          'despriorizada': 'pending',
          'reprovado': 'rejected'
        };
        
        const internalStatus = statusMap[bug.properties.status?.toLowerCase()] || 'pending';
        
        // Criar descri√ß√£o completa com todos os detalhes
        let fullDescription = bug.content.resumo || '';
        
        if (bug.content.passosReproduzir) {
          fullDescription += '\n\n**Passos para Reproduzir:**\n';
          fullDescription += bug.content.passosReproduzir.map((passo, i) => `${i + 1}. ${passo}`).join('\n');
        }
        
        if (bug.content.resultadoAtual) {
          fullDescription += '\n\n**Resultado Atual:**\n';
          fullDescription += bug.content.resultadoAtual;
        }
        
        if (bug.content.resultadoEsperado) {
          fullDescription += '\n\n**Resultado Esperado:**\n';
          fullDescription += bug.content.resultadoEsperado;
        }
        
        if (bug.content.criteriosAceitacao) {
          fullDescription += '\n\n**Crit√©rios de Aceita√ß√£o:**\n';
          fullDescription += bug.content.criteriosAceitacao.map(criterio => `- ${criterio}`).join('\n');
        }
        
        if (bug.content.impactoNegocio) {
          fullDescription += '\n\n**Impacto no Neg√≥cio:**\n';
          fullDescription += bug.content.impactoNegocio;
        }
        
        if (bug.content.sugestaoCorrecao) {
          fullDescription += '\n\n**Sugest√£o de Corre√ß√£o:**\n';
          fullDescription += bug.content.sugestaoCorrecao.map(sugestao => `- ${sugestao}`).join('\n');
        }
        
        if (bug.content.observacoesAdicionais) {
          fullDescription += '\n\n**Observa√ß√µes Adicionais:**\n';
          fullDescription += bug.content.observacoesAdicionais;
        }
        
        const bugData = {
          notionBugId: bug.id,
          bugTitle: bug.title,
          bugDescription: fullDescription,
          status: internalStatus,
          bugLevel: 1,
          notionDetails: {
            // Propriedades b√°sicas
            categoria: bug.properties.categoria || [],
            modulo: bug.properties.modulo || [],
            prioridade: bug.properties.prioridade || 0,
            dataPrevista: bug.properties.dataPrevista || false,
            criadoPor: bug.properties.criadoPor || '',
            editadoEm: bug.properties.editadoEm ? new Date(bug.properties.editadoEm) : new Date(),
            url: bug.url,
            
            // Conte√∫do estruturado
            resumo: bug.content.resumo || '',
            passosReproduzir: bug.content.passosReproduzir || [],
            resultadoAtual: bug.content.resultadoAtual || '',
            resultadoEsperado: bug.content.resultadoEsperado || '',
            criteriosAceitacao: bug.content.criteriosAceitacao || [],
            dadosUteis: {
              console: bug.content.dadosUteis?.console || '',
              requestResponse: bug.content.dadosUteis?.requestResponse || '',
              payloadEsperado: bug.content.dadosUteis?.payloadEsperado || ''
            },
            impactoNegocio: bug.content.impactoNegocio || '',
            sugestaoCorrecao: bug.content.sugestaoCorrecao || [],
            observacoesAdicionais: bug.content.observacoesAdicionais || '',
            anexos: bug.content.anexos || [],
            
            // Para ideias
            descricao: bug.content.descricao || '',
            importancia: bug.content.importancia || [],
            dadosApoio: bug.content.dadosApoio || ''
          },
          rawData: {
            url: bug.url,
            properties: bug.properties,
            content: bug.content,
            extractedAt: new Date().toISOString(),
            source: 'MCP_Notion_Enhanced'
          }
        };
        
        // Verificar se bug j√° existe
        const existingBug = await BugMetrics.findOne({ notionBugId: bug.id });
        
        if (existingBug) {
          console.log(`   ‚úÖ Atualizando bug existente`);
          existingBug.bugTitle = bugData.bugTitle;
          existingBug.bugDescription = bugData.bugDescription;
          existingBug.status = bugData.status;
          existingBug.notionDetails = bugData.notionDetails;
          existingBug.rawData = bugData.rawData;
          existingBug.updatedAt = new Date();
          
          await existingBug.save();
          updatedCount++;
        } else {
          console.log(`   üÜï Criando novo bug`);
          const newBug = new BugMetrics(bugData);
          await newBug.save();
          syncedCount++;
        }
        
        console.log(`   üìù "${bugData.bugTitle}" - ${bugData.status}`);
        console.log(`   üìä Descri√ß√£o: ${bugData.bugDescription.length} caracteres`);
        
      } catch (error) {
        console.log(`‚ùå Erro: ${error.message}`);
        errors.push({
          pageId: bug.id,
          error: error.message
        });
      }
    }
    
    console.log(`\nüéâ Sincroniza√ß√£o detalhada conclu√≠da!`);
    console.log(`üìä Total: ${enhancedBugs.length} bugs/ideias`);
    console.log(`‚úÖ Novos: ${syncedCount}`);
    console.log(`üîÑ Atualizados: ${updatedCount}`);
    console.log(`‚ùå Erros: ${errors.length}`);
    
    if (errors.length > 0) {
      console.log(`\n‚ùå Detalhes dos erros:`);
      errors.forEach(error => {
        console.log(`   ${error.pageId}: ${error.error}`);
      });
    }
    
    // Estat√≠sticas dos dados
    const bugs = enhancedBugs.filter(b => b.properties.categoria.includes('Bug'));
    const ideias = enhancedBugs.filter(b => !b.properties.categoria.includes('Bug'));
    
    console.log(`\nüìà Estat√≠sticas:`);
    console.log(`   üêõ Bugs: ${bugs.length}`);
    console.log(`   üí° Ideias: ${ideias.length}`);
    console.log(`   ‚úÖ Conclu√≠dos: ${enhancedBugs.filter(b => b.properties.status === 'Conclu√≠do').length}`);
    console.log(`   üü£ Prontos para teste: ${enhancedBugs.filter(b => b.properties.status === 'Pronto pra teste').length}`);
    console.log(`   ‚ö™ N√£o iniciados: ${enhancedBugs.filter(b => b.properties.status === 'N√£o iniciada').length}`);
    
  } catch (error) {
    console.log('‚ùå Erro geral:', error.message);
  } finally {
    await mongoose.disconnect();
    console.log('üîå Desconectado do MongoDB');
  }
}

// Executar se chamado diretamente
if (require.main === module) {
  syncEnhancedBugs();
}

module.exports = { syncEnhancedBugs, enhancedBugs };
